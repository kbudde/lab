apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    a8r.io/repository: git@github.com:kbudde/lab.git
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
    helm.sh/hook-weight: "-5"
  labels:
    app.kubernetes.io/instance: k8s-monitoring
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/version: 1.3.7
    helm.sh/chart: k8s-monitoring-0.3.0
  name: validate-k8s-monitoring
  namespace: grafana-agent
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app.kubernetes.io/instance: k8s-monitoring
        app.kubernetes.io/managed-by: Helm
        helm.sh/chart: k8s-monitoring-0.3.0
      name: validate-k8s-monitoring
    spec:
      containers:
        - command:
            - bash
            - -ec
            - |
              echo Validating config file
              grafana-agent fmt /etc/agent/config.river
              echo Validating logs config file
              grafana-agent fmt /etc/agent/logs.river
          env:
            - name: AGENT_MODE
              value: flow
          image: docker.io/grafana/agent:v0.37.3
          name: grafana-agent
          volumeMounts:
            - mountPath: /etc/agent
              name: config
      restartPolicy: Never
      volumes:
        - configMap:
            name: validate-k8s-monitoring
          name: config
